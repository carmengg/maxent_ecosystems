---
title: "eco_maxent_observations_preparation"
author: "Carmen Galaz-Garc√≠a"
date: "1/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(21)
librarian::shelf(
  here, 
  raster,
  rgdal, 
  sf,
  dismo)

```

# Load Predictor Layers

```{r}
env_stack <- raster::stack(here("oaks","env_layers","sb_env_stack.grd"))
plot(env_stack)
```

# Load oak woodlands presence points

```{r}
# #obs <- sf::read_sf(here("maxent_eco_classification","oak_samples","oaks_sample.geojson"))
# presence <- sf::read_sf(here("oaks","oaks_data","oaks_sample.geojson"))
# presence <- st_transform(presence,crs(env_stack))
# 
# # p = presence
# p_pts_split  <- rsample::initial_split(presence, prop = 0.8)
# p_pts_train  <- rsample::training(p_pts_split)
# p_pts_test   <- rsample::testing(p_pts_split)
# rm(p_pts_split)

```

# Load oak woodlands absence points

```{r}
# #obs <- sf::read_sf(here("maxent_eco_classification","oak_samples","oaks_sample.geojson"))
# absence <- sf::read_sf(here("oaks","oaks_data","oaks_absences.geojson"))
# absence <- st_transform(absence,crs(env_stack))
# 
# # a = presence
# a_pts_split  <- rsample::initial_split(absence, prop = 0.8)
# a_pts_train  <- rsample::training(a_pts_split)
# a_pts_test   <- rsample::testing(a_pts_split)
# rm(a_pts_split)

```


# Load train set
```{r}
train <- read_csv(here("oaks","oaks_data","oaks_train.csv"))
test <- read_csv(here("oaks","oaks_data","oaks_test.csv"))

p_pts_train <- train %>% 
  filter(presence==1) %>% 
  select(X,Y) %>% 
  sf::st_as_sf(coords=c("X","Y"))

a_pts_train <- train %>% 
  filter(presence==0) %>% 
  select(X,Y) %>% 
  sf::st_as_sf(coords=c("X","Y"))
```


# Run Maxent model

```{r}
#env_stack<- dropLayer(env_stack,"temp_seasonality")
maxent_model <- maxent(env_stack, 
                       p = sf::as_Spatial(p_pts_train),
                       a = sf::as_Spatial(a_pts_train))
plot(maxent_model)
```

```{r}
y_maxv <- predict(env_stack, maxent_model) #, ext=ext, progress='')
plot(y_maxv, main='Maxent prediction')

```

# Load test set

```{r}
test <- read_csv(here("oaks","oaks_data","oaks_test.csv"))

p_pts_test <- test %>% 
  filter(presence==1) %>% 
  select(X,Y)

a_pts_test <- test %>% 
  filter(presence==0) %>% 
  select(X,Y) 
```


```{r}

e <- dismo::evaluate(
  p     = p_pts_test,
  a     = a_pts_test, 
  model = maxent_model,
  x     = env_stack)
e
```

```{r}
plot(e, 'ROC')

thr <- threshold(e)[['spec_sens']]
# the threshold at which the sum of the sensitivity (true positive rate) and specificity (true negative rate) is highest
thr
```


```{r}
p_true <- na.omit(raster::extract(y_maxv, p_pts_test) >= thr)
tpr <- sum(p_true)/length(p_true)  # % true positive
fnr <- sum(!p_true)/length(p_true) # % false negative 

a_true <- na.omit(raster::extract(y_maxv, a_pts_test) < thr)
fpr <- sum(!a_true)/length(a_true) # % false negative
tnr <- sum(a_true)/length(a_true) # % true negative



matrix(
  c(tpr, fpr,
    fnr, tnr), 
  nrow=2, 
  byrow= TRUE, 
  dimnames = list(
    c("present_obs", "absent_obs"),
    c("present_pred", "absent_pred")))
```

